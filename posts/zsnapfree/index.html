<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>zsnapfree - Shallow and Pedantic</title><meta name=Description content="A person/tech/code blog of a coder/techie/person. Like calculus in a kiddie pool, the author of this blog is known to be quite shallow and pedantic."><meta property="og:url" content="https://lutzky.net/posts/zsnapfree/">
<meta property="og:site_name" content="Shallow and Pedantic"><meta property="og:title" content="zsnapfree"><meta property="og:description" content="Copy-on-write makes snapshots fast and accessible, but deleting them to reclaim disk space can be a bit confusing. Let‚Äôs have a quick primer on how those work, and look at a small utility to help reason about it.
zsnapfree is a TUI for showing how much space can be reclaimed by freeing zfs snapshots. It is a TUI wrapper over the standard zfs tool.
If you just want to see zsnapfree in action, skip to the screencast."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-23T00:00:00+00:00"><meta property="article:modified_time" content="2025-01-30T13:45:14+00:00"><meta property="article:tag" content="Software"><meta property="og:image" content="https://lutzky.net/images/bio-photo-small.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://lutzky.net/images/bio-photo-small.jpg"><meta name=twitter:title content="zsnapfree"><meta name=twitter:description content="Copy-on-write makes snapshots fast and accessible, but deleting them to reclaim disk space can be a bit confusing. Let‚Äôs have a quick primer on how those work, and look at a small utility to help reason about it.
zsnapfree is a TUI for showing how much space can be reclaimed by freeing zfs snapshots. It is a TUI wrapper over the standard zfs tool.
If you just want to see zsnapfree in action, skip to the screencast."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://lutzky.net/posts/zsnapfree/><link rel=prev href=https://lutzky.net/posts/slow-boot/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"zsnapfree","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/lutzky.net\/posts\/zsnapfree\/"},"genre":"posts","keywords":"software","wordcount":820,"url":"https:\/\/lutzky.net\/posts\/zsnapfree\/","datePublished":"2024-08-23T00:00:00+00:00","dateModified":"2025-01-30T13:45:14+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Ohad Lutzky"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Shallow and Pedantic">Shallow and Pedantic</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/stuff/>Stuff </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Shallow and Pedantic">Shallow and Pedantic</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/stuff/ title>Stuff</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">zsnapfree</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Ohad Lutzky</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2024-08-23>2024-08-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;820 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;4 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#what-are-cow-snapshots->What are COW snapshots? üêÆ</a></li><li><a href=#accidentally-storing-big-files>Accidentally storing big files</a></li><li><a href=#the-good-stuff>Dealing with long snapshot names</a></li></ul></nav></div></div><div class=content id=content><p>Copy-on-write makes snapshots fast and accessible, but deleting them to
reclaim disk space can be a bit confusing. Let&rsquo;s have a quick primer on how
those work, and look at a small utility to help reason about it.</p><p><a href=https://github.com/lutzky/zsnapfree target=_blank rel="noopener noreffer">zsnapfree</a> is a TUI for showing how much
space can be reclaimed by freeing zfs snapshots. It is a TUI wrapper over the
standard zfs tool.</p><p>If you just want to see zsnapfree in action, skip to <a href=#the-good-stuff rel>the screencast</a>.</p><h2 id=what-are-cow-snapshots->What are COW snapshots? üêÆ</h2><p>We all have little accidents with our files. Although the &ldquo;Recycle bin&rdquo; protects
you against accidentally <em>deleting</em> files, most filesystems don&rsquo;t protect
against accidentally <em>modifying</em> them. To change files back, you want a
filesystems with <em>snapshots</em>.</p><p>A snapshot is extremely fast to make, and lets you access the contents of the
file as it was when the snapshot was taken. In ZFS, with <code>zfs-auto-snapshot</code>
installed, the experience might look like this:</p><ul><li>A ZFS filesystem called <code>/tank/videos</code> exists.</li><li>A file <code>/tank/videos/renders/my_video.mp4</code> exists, but I accidentally
overwrite it.</li><li>The file has existed for a while, so <code>zfs-auto-snapshot</code> has already created
a snapshot of the good version at 14:17; specifically, it&rsquo;s called <code>zfs-auto-snap_hourly-2024-08-20-1417</code>.</li><li>The good version is therefore available at (takes a breath)
<code>/tank/videos/.zfs/snapshot/zfs-auto-snap_hourly-2024-08-20-1417/renders/my_video.mp4</code>.</li></ul><p>We&rsquo;ll get back to those long snapshot names later. For now, it&rsquo;s worth sketching
out how this works.</p><p>The actual ZFS implementation is more complex, but roughly speaking, you can
imagine that the <code>videos</code> &ldquo;current-state&rdquo; is represented by a table that
includes rows describing what 128KB blocks make up each file. If our file
<code>renders/my_video.mp4</code> is 128MB, it will be made up of 1024 blocks, and the
table might have a section like this:</p><ul><li>File <code>renders/my_video</code> is represented by virtual blocks 1000 through 2023.</li><li>Virtual block 1000 is in physical location 5001</li><li>Virtual block 1001 is in physical location 6713</li><li>&mldr;</li></ul><p>To create a snapshot, we only need to duplicate the information above, which is
roughly 8KB, so this can be done quickly and for very little extra space.
However, what happens when the data changes? Snapshots should remain immutable
even if the &ldquo;current-state&rdquo; changes.</p><p>Suppose for instance we change the very first block in the file - virtual block
1000. What happens now is the titular &ldquo;copy-on-write&rdquo; - the block which needs to
be rewritten will first be copied. Physical location 5001 would be duplicated to
a new location, say 7001, and this version of the block will be modified. The
current-state table would be updated to say that virtual block 1000 is in
physical location 7001 (but the snapshot would still have it listed as physical
location 5001).</p><p>Importantly, physical location 5001 is still in use, and cannot be freed. There
would likely be a table keeping reference counts for each physical location;
after the last snapshot referencing it would be deleted, this space can be
reclaimed.</p><h2 id=accidentally-storing-big-files>Accidentally storing big files</h2><p>Suppose you accidentally store <code>useless_data.zip</code>, a 100GB file, in a filesystem
that takes snapshots. You find yourself running out of space, and decide to
delete that file&mldr; but no space is recovered. The reason is that snapshots
still hold this data, and you would need to delete all of those snapshots in
order to reclaim it.</p><p>The question is&mldr; which ones? Although you can run <code>zfs list -t snapshot -o space</code>, the <code>USED</code> column there only counts space used by files which are
<em>unique to that snapshot</em>. That is, if another snapshot has been created (e.g.
by <code>zfs-auto-snapshot</code>), the <code>USED</code> column will count that file as zero.</p><p>Fortunately, ZFS has a great utility for previewing this. If we believe that the
file was created just before <code>snapshot1</code>, and deleted just after <code>snapshot3</code>,
then we can do this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ zfs destroy -nv tank/video@snapshot1,snapshot2,snapshot3
</span></span><span class=line><span class=cl>would destroy tank/video@snapshot1
</span></span><span class=line><span class=cl>would destroy tank/video@snapshot2
</span></span><span class=line><span class=cl>would destroy tank/video@snapshot3
</span></span><span class=line><span class=cl>would reclaim 100GB
</span></span></code></pre></td></tr></table></div></div><p>This command actually does nothing (<code>-n</code>) except show information. Critically,
running it with just one or two of the snapshots would reclaim 0GB, so this is
great for harmless reasoning about what snapshots we&rsquo;d need to sacrifice to
reclaim space. There&rsquo;s even a handy <code>%</code> &ldquo;range&rdquo; operator, so we could rewrite
the above as <code>tank/videos@snapshot1%snapshot3</code>.</p><h2 id=the-good-stuff>Dealing with long snapshot names</h2><p>The unrealistic thing about the previous example is the short and convenient
snapshot names. <code>zfs-auto-snapshot</code> is great, but the snapshot names are more
like <code>zfs-auto-snap_hourly-2024-08-20-1417</code>. This makes trying different
snapshot selections cumbersome, and prompted me to write my very first TUI app
in Rust. It&rsquo;s a simple wrapper around the <code>zfs</code> command, and, well, a video is
worth several words:</p><div id=zsnapfree></div><script src=https://lutzky.net//js/asciinema-player.min.js></script><script>AsciinemaPlayer.create("/casts/zsnapfree.cast",document.getElementById("zsnapfree"),{})</script><p>When selecting snapshots, the tool runs (after a short delay) <code>zfs destroy -n</code>
to show how much space would be reclaimed. On exit, it shows the appropriate
commandline to check its findings and, if removing <code>-n</code>, actually perform the
deletion. Hopefully this is of some use for ZFS users, and I would love any
patches to add support for other filesystems that have snapshot support!</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2025-01-30</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://lutzky.net/posts/zsnapfree/ data-hashtag=software><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on WhatsApp" data-sharer=whatsapp data-url=https://lutzky.net/posts/zsnapfree/ data-title=zsnapfree data-web><i class="fab fa-whatsapp fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://lutzky.net/posts/zsnapfree/ data-title=zsnapfree><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on ÂæÆÂçö" data-sharer=weibo data-url=https://lutzky.net/posts/zsnapfree/ data-title=zsnapfree><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/software/>Software</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/slow-boot/ class=prev rel=prev title="Adventures with slow boot"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Adventures with slow boot</a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.143.1">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Ohad Lutzky</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://shallowandpedantic.disqus.com/embed.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},lightgallery:!0,search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1VCTD5H9YR",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-1VCTD5H9YR" async></script></body></html>